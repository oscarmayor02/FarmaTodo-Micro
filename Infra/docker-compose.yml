version: "3.9"

services:
  # ========= PostgreSQL por micro =========
  pg_tokenization:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: tokenization
    ports: ["5433:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d tokenization"]
      interval: 10s
      timeout: 3s
      retries: 20

  pg_customers:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: customers
    ports: ["5434:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d customers"]
      interval: 10s
      timeout: 3s
      retries: 20

  pg_products:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: products
    ports: ["5435:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d products"]
      interval: 10s
      timeout: 3s
      retries: 20

  pg_orders:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: orders
    ports: ["5436:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d orders"]
      interval: 10s
      timeout: 3s
      retries: 20

  pg_payments:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: payments
    ports: ["5437:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d payments"]
      interval: 10s
      timeout: 3s
      retries: 20

  pg_cart:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: cart
    ports: ["5439:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d cart"]
      interval: 10s
      timeout: 3s
      retries: 20

  pg_audit:
    image: postgres:16
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: audit
    ports: ["5440:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d audit"]
      interval: 10s
      timeout: 3s
      retries: 20

  # ========= Microservicios =========

  tokenization-service:
    build: ../tokenization
    environment:
      SERVER_PORT: 8081
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_tokenization:5432/tokenization
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}
      API_KEY_TOKENIZATION: ${API_KEY}        # <- typo corregido
      TOKEN_REJECTION_PROB: "0.15"
      TOKEN_HMAC_SECRET: ${TOKEN_HMAC_SECRET}
      CRYPTO_KEY_HEX: ${CRYPTO_KEY_HEX}
    depends_on:
      pg_tokenization:
        condition: service_healthy
    ports: ["8081:8081"]

  customers-service:
    build: ../Customers                # <— ruta corregida (antes: ./customers-service)
    environment:
      SERVER_PORT: 8082
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_customers:5432/customers
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}
      API_KEY_CUSTOMERS: ${API_KEY}
    depends_on:
      pg_customers:
        condition: service_healthy
    ports: ["8082:8082"]

  products-service:
    build: ../Product                  # <— ruta corregida (antes: ./products-service)
    environment:
      SERVER_PORT: 8084                 # <- products en 8084
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_products:5432/products
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}
      API_KEY_PRODUCTS: ${API_KEY}
      MIN_STOCK_VISIBLE: "1"
    depends_on:
      pg_products:
        condition: service_healthy
    ports: ["8084:8084"]               # <- mapeo correcto

  orders-service:
    build: ../Orders                   # <— ruta corregida (antes: ./orders-service)
    environment:
      SERVER_PORT: 8085                 # <- orders en 8085
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_orders:5432/orders
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}
      API_KEY_ORDERS: ${API_KEY}

      # Clients internos
      CUSTOMER_URL: http://customers-service:8082
      API_KEY_CUSTOMERS: ${API_KEY}

      PRODUCT_URL: http://products-service:8084     # <- apunta a 8084
      API_KEY_PRODUCTS: ${API_KEY}

      PAYMENTS_URL: http://payments-service:8083
      API_KEY_PAYMENTS: ${API_KEY}

      AUDIT_BASE_URL: http://audit-service:8088
      AUDIT_API_KEY: ${API_KEY}
    depends_on:
      pg_orders:
        condition: service_healthy
      customers-service:
        condition: service_started
      products-service:
        condition: service_started
      payments-service:
        condition: service_started
      audit-service:
        condition: service_started
    ports: ["8085:8085"]

  payments-service:
    build: ../Payments                 # <— ruta corregida (antes: ./payments-service)
    environment:
      SERVER_PORT: 8083
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_payments:5432/payments
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}

      API_KEY_PAYMENTS: ${API_KEY}

      TOKENIZATION_BASE_URL: http://tokenization-service:8081
      TOKENIZATION_API_KEY: ${API_KEY}

      PAYMENT_REJECTION_PROB: "0.20"
      PAYMENT_MAX_RETRIES: "2"
      PAYMENT_BACKOFF_MS: "200"

      NOTIFICATIONS_BASE_URL: http://notifications-service:8086
      NOTIFICATIONS_API_KEY: ${API_KEY}

      AUDIT_BASE_URL: http://audit-service:8088
      AUDIT_API_KEY: ${API_KEY}

      TRACING_HEADER: X-TX-ID
    depends_on:
      pg_payments:
        condition: service_healthy
      tokenization-service:
        condition: service_started
      notifications-service:
        condition: service_started
      audit-service:
        condition: service_started
    ports: ["8083:8083"]

  cart-service:
    build: ../Cart                     # <— ruta corregida (antes: ./cart-service)
    environment:
      SERVER_PORT: 8087
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_cart:5432/cart
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}
      API_KEY_CART: ${API_KEY}

      PRODUCT_BASE_URL: http://products-service:8084   # <- products en 8084
      PRODUCT_API_KEY: ${API_KEY}
      CART_VALIDATE_PRODUCT: "true"
    depends_on:
      pg_cart:
        condition: service_healthy
      products-service:
        condition: service_started
    ports: ["8087:8087"]

  notifications-service:
    build: ../Notification          # <— ruta corregida (antes: ./notifications-service)
    environment:
      SERVER_PORT: 8086
      API_KEY_NOTIFICATIONS: ${API_KEY}

      # Gmail SMTP
      MAIL_FROM: ${MAIL_FROM}
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    ports: ["8086:8086"]

  audit-service:
    build: ../AuditLog                # <— ruta corregida (antes: ./audit-service)
    environment:
      SERVER_PORT: 8088
      SPRING_DATASOURCE_URL: jdbc:postgresql://pg_audit:5432/audit
      SPRING_DATASOURCE_USERNAME: ${PG_USER}
      SPRING_DATASOURCE_PASSWORD: ${PG_PASSWORD}
      API_KEY_AUDIT: ${API_KEY}
    depends_on:
      pg_audit:
        condition: service_healthy
    ports: ["8088:8088"]
